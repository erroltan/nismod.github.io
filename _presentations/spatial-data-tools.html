---
title: Spatial Data Tools
layout: presentation
---

# Spatial Data Tools

## Desktop GIS
QGIS for viewing spatial data

## Spatial data formats
ogr2ogr for converting between formats

## Spatial databases
Postgres and PostGIS for storing and querying against a database

## Spatial data libraries
GDAL for handling spatial objects in code

## Estimating memory usage and profiling code
valgrind or language-specific profilers

---

# Install

## OSGeo4W
This a bundle installer for Windows that includes QGIS, GDAL and other tools.

[https://trac.osgeo.org/osgeo4w/](https://trac.osgeo.org/osgeo4w/)

## QGIS
[http://www.qgis.org/](http://www.qgis.org/)

## Postgres
[https://www.postgresql.org/](https://www.postgresql.org/)

## PostGIS
[http://postgis.net/](http://postgis.net/)

---

# Desktop GIS

## QGIS

Docs: [http://www.qgis.org/en/docs/index.html](http://www.qgis.org/en/docs/index.html)

Tutorial: [http://docs.qgis.org/2.14/en/docs/training_manual/index.html](http://docs.qgis.org/2.14/en/docs/training_manual/index.html)

## ArcGIS

If you have access to ArcGIS, then [ArcMap](http://desktop.arcgis.com/en/arcmap/)
or [ArcGIS Pro](http://pro.arcgis.com/en/pro-app/) have similar feature sets.

---

# QGIS: view data

- new project
- folder structure (importance of relative references)
- import shapefile
- zoom to layer
- view attribute table
- identify node
- layer properties
    - style
    - labels


---

# Data formats

- shapefile
- csv
- geojson
- kml
- osm.xml, osm.pbf
- WKT, WKB
- sql

Vector: [http://www.gdal.org/ogr_formats.html](http://www.gdal.org/ogr_formats.html)
Raster: [http://www.gdal.org/formats_list.html](http://www.gdal.org/formats_list.html)

---

# Shapefile

Spec: [https://www.esri.com/library/whitepapers/pdfs/shapefile.pdf](https://www.esri.com/library/whitepapers/pdfs/shapefile.pdf)

Essential files
- `*.shp` main file, contains geometric data
- `*.shx` index file, contains offsets and content length for records in the main file
- `*.dbf` dBASE table, contains the attribute table

Other files
- `*.sbn`, `*.sbx` spatial index
- `*.prj` projection details
- `*.shp.xml` spatial metadata
- `*.cpg` dBASE metadata (text encoding codepage, eg `UTF8`)

---

# Delimited text

CSV

```csv
X,Y,osm_id,timestamp,name,type
34.4613073,31.506574,504259355,2014-08-09T17:22:21Z,Arab Bank,bank
34.4443115,31.5201754,504263800,2012-12-18T13:47:22Z,Quds Bank,bank
34.4552552,31.5164901,4210637190,2016-05-27T12:06:42Z,بنك القدس فرع غزة,bank
```

Tab-delimited

```txt
lon   lat osm_id  timestamp    name   type
34.3197512  31.3034058   329170797 2009-02-17T06:55:01Z    European Gaza Hospital - مستشفى غزة ا  hospital
34.4937895  31.5406455   503999419 2009-09-21T12:32:03Z    Palestinian Medical Relief hospital
```

---

# GeoJSON

Spec: [https://tools.ietf.org/html/rfc7946](https://tools.ietf.org/html/rfc7946)

Guide: [http://geojson.org/](http://geojson.org/)

```json
{
  "type": "Feature",
  "geometry": {
    "type": "Point",
    "coordinates": [125.6, 10.1]
  },
  "properties": {
    "name": "Dinagat Islands"
  }
}
```

---

# KML

Spec: [http://www.opengeospatial.org/standards/kml/](http://www.opengeospatial.org/standards/kml/)

Guide: [https://developers.google.com/kml/](https://developers.google.com/kml/)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Placemark>
    <name>Simple placemark</name>
    <description>Attached to the ground. Intelligently places itself
       at the height of the underlying terrain.</description>
    <Point>
      <coordinates>-122.0822035425683,37.42228990140251,0</coordinates>
    </Point>
  </Placemark>
</kml>
```

---

# OpenStreetMap XML

Notes: [http://wiki.openstreetmap.org/wiki/OSM_XML](http://wiki.openstreetmap.org/wiki/OSM_XML)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<osm version="0.6" generator="CGImap 0.0.2">
 <bounds minlat="54.0889580" minlon="12.2487570" maxlat="54.0913900" maxlon="12.2524800"/>
 <node id="298884269" lat="54.0901746" lon="12.2482632" user="SvenHRO" uid="46882" visible="true" version="1" changeset="676636" timestamp="2008-09-21T21:37:45Z"/>
 <node id="1831881213" version="1" changeset="12370172" lat="54.0900666" lon="12.2539381" user="lafkor" uid="75625" visible="true" timestamp="2012-07-20T09:43:19Z">
  <tag k="name" v="Neu Broderstorf"/>
  <tag k="traffic_sign" v="city_limit"/>
 </node>
 <way id="26659127" user="Masch" uid="55988" visible="true" version="5" changeset="4142606" timestamp="2010-03-16T11:47:08Z">
  <nd ref="292403538"/>
  <nd ref="298884289"/>
  <tag k="highway" v="unclassified"/>
  <tag k="name" v="Pastower Straße"/>
 </way>
 <relation id="56688" user="kmvar" uid="56190" visible="true" version="28" changeset="6947637" timestamp="2011-01-12T14:23:49Z">
  <member type="node" ref="294942404" role=""/>
  <member type="way" ref="4579143" role=""/>
  <tag k="name" v="Küstenbus Linie 123"/>
  <tag k="type" v="route"/>
 </relation>
</osm>
```

---

# OpenStreetMap PBF

PBF (Protocol Buffers) are a binary serialization format.

Guide: [https://developers.google.com/protocol-buffers/](https://developers.google.com/protocol-buffers/)

OpenStreetMap define a particular set of protocols against pbf.

OSM PBF usage: [http://wiki.openstreetmap.org/wiki/PBF_Format](http://wiki.openstreetmap.org/wiki/PBF_Format)

---

# WKT, WKB - Well-Known Text/Binary

```txt
POINT (34.4613073 31.506574)
```

```txt
0101000020E6100000AA6D799BED284140AE6AA400AC4D3F40
```

```txt
POLYGON ((34.4613073 31.5067543780869,34.4613438592451 31.5067516377333,34.46137
93076498 31.5067434999371,34.4614125681267 31.5067302119626,34.4614426300691 31.
5067121775601,34.4614685800579 31.5066899446983,34.4614896296158 31.506664188914
2,34.4615051391647 31.5066356927868,34.461514637459 31.5066053221585,34.46151783
59033 31.5065739998268,34.4615146373208 31.5065426775054,34.4615051389048 31.506
5123069068,34.4614896292656 31.5064838108247,34.4612707407549 31.5067516377333,3
4.4613073 31.5067543780869))
```

---

# SQL

```sql
INSERT INTO "public"."gaza_hospitals" (
    "wkb_geometry" ,
    "osm_id",
    "timestamp",
    "name",
    "type"
) VALUES (
    '0101000020E6100000AA6D799BED284140AE6AA400AC4D3F40',
    '329170797',
    '2009-02-17T06:55:01Z',
    'European Gaza Hospital - مستشفى غزة ا',
    'hospital'
);
```

---

# ogr2ogr

Docs: http://www.gdal.org/ogr2ogr.html

- convert between formats (shp/osm/geojson/csv/sql...)
- transform between coordinate systems (WGS84/OSGB36/Web mercator...)
- clip regions
- simplify geometries
- filter fields

Other GDAL utilities: http://gdal.org/gdal_utilities.html

---

# PostGIS

Docs: [http://postgis.net/docs/manual-2.3/](http://postgis.net/docs/manual-2.3/)

Tutorial: [http://workshops.boundlessgeo.com/postgis-intro/index.html](http://workshops.boundlessgeo.com/postgis-intro/index.html)

PostGIS is an extension to Postgres. It needs to be enabled once per database.

```bash
createdb spatial_data_workshop # create new database
psql -d spatial_data_workshop  # log in to database using command line client
CREATE EXTENSION postgis;      # create postgis extension
```

--

Store spatial data alongside standard data types

```sql
CREATE TABLE workshop_nodes (
    node_id serial PRIMARY KEY         -- Primary key and id field
    , node_name text                   -- Name of node asset
    , condition integer                -- Rating of node condition (good, average, poor)
    , last_updated timestamp with time zone DEFAULT now()
    , properties jsonb                 -- Key-value map of additional node-specific attributes
    , location geography(POINT, 4326)  -- Node geometry (GIS location, shape)
);
```

---

# More PostGIS

Create geographical index

```sql
CREATE INDEX workshop_nodes_gist ON workshop_nodes USING GIST ( location );
```

--

Add custom data type to provide a category-type field

```sql
CREATE TYPE data_status AS ENUM ('staged', 'approved', 'archived');

ALTER TABLE workshop_nodes ADD COLUMN status data_status DEFAULT 'staged'
```


---

# GDAL

Comes installed with OSGeo4W or QGIS.

- Windows binaries are maintained at: [http://www.gisinternals.com/](http://www.gisinternals.com/) (or [build](https://trac.osgeo.org/gdal/wiki/BuildingOnWindows))
- Mac binaries are available at: [http://www.kyngchaos.com/software/frameworks#gdal_complete](http://www.kyngchaos.com/software/frameworks#gdal_complete) or `brew install gdal`
- Ubuntu has a default package: `sudo apt-get install gdal-bin` (or [build])

C++/C library with [bindings](https://trac.osgeo.org/gdal/wiki#GDALOGRInOtherLanguages)
for other languages.

- Python [https://pypi.python.org/pypi/pygdal/1.10.1.0](https://pypi.python.org/pypi/pygdal/1.10.1.0)
- Java [https://trac.osgeo.org/gdal/wiki/GdalOgrInJava](https://trac.osgeo.org/gdal/wiki/GdalOgrInJava)
- C# [https://trac.osgeo.org/gdal/wiki/GdalOgrInCsharp](https://trac.osgeo.org/gdal/wiki/GdalOgrInCsharp)
- R [https://cran.r-project.org/web/packages/rgdal/index.html](https://cran.r-project.org/web/packages/rgdal/index.html)

---

# GDAL capabilities

Cookbook: https://pcjericks.github.io/py-gdalogr-cookbook/index.html

Do any common spatial operation programmatically
- create points, lines, polygons
- calculate length, area, buffer
- calculate intersection, union
- filter geometries by attribute
- read or write to spatial data formats

---

# Valgrind

Docs: [http://valgrind.org/docs/manual/manual.html](http://valgrind.org/docs/manual/manual.html)

A suite of tools that run on Linux and UNIX platforms (including Mac OS X).

Massif: [http://valgrind.org/info/tools.html#massif](http://valgrind.org/info/tools.html#massif)

Massif is a heap profiler, it analyses and tracks a program's heap usage and memory allocations.

Graph total program memory usage.

<small>Note: the 'heap' is one kind of memory area provided by an operating system for
a program to store values; the other kind is the 'stack'. High level languages
(like Python or Java) don't generally expose these details to the programmer.</small>

---

# Python memory profiler

Docs: https://pypi.python.org/pypi/memory_profiler

Analyses memory usage of a particular function, line by line